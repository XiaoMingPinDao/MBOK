# =================================================================
# GitHub Actions å·¥ä½œæµï¼š
# è‡ªåŠ¨æ„å»ºå¹¶æ¨é€ä¸¤ä¸ªä¸åŒç”¨é€”çš„ Docker é•œåƒ
# =================================================================

name: Build and Push Both Docker Images

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ„å»ºğŸ˜‹
    - cron: '0 19 * * *'

jobs:
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2ï¼šç™»å½•åˆ° Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # æ­¥éª¤ 3ï¼šæ„å»ºå¹¶æ¨é€ Antlia é•œåƒ
      - name: Build and Push antlia Image (:latest)
        run: |
          IMAGE_NAME="zhende1113/antlia"  # ä½ çš„ Docker Hub é•œåƒå
          echo "Building Auto-run image from Dockerfile.autorun"
          
          # ä½¿ç”¨ -f æŒ‡å®š Dockerfile.autorun
          # åŒæ—¶æ‰“ä¸Š latest å’Œæ—¥æœŸæ ‡ç­¾
          docker build \
            -f Dockerfile.antlia \
            -t "${IMAGE_NAME}:latest" \
            -t "${IMAGE_NAME}:$(date +%Y%m%d)" \
            .
            
          # æ¨é€æ‰€æœ‰æ ‡ç­¾ (latest å’Œ æ—¥æœŸ)
          docker push --all-tags "${IMAGE_NAME}"

      # æ­¥éª¤ 4ï¼šæ„å»ºå¹¶æ¨é€ eridanus-docker-unofficialé•œåƒ
      - name: Build and Push eridanus-docker-unofficial (:latest-manual)
        run: |
          IMAGE_NAME="zhende1113/eridanus-docker-unofficial"  # ä½ çš„ Docker Hub é•œåƒå
          echo "Building Manual-exec image from Dockerfile.manual"
          
          # ä½¿ç”¨ -f æŒ‡å®š Dockerfile
          # æ‰“ä¸Šä¸€ä¸ªæ¸…æ™°çš„ã€è¡¨ç¤ºç”¨é€”çš„æ ‡ç­¾ï¼Œä¾‹å¦‚ 'latest-manual'
          docker build \
            -f Dockerfile \
            -t "${IMAGE_NAME}:latest-manual" \
            .
          
          # æ¨é€è¿™ä¸ªç‰¹å®šçš„ manual æ ‡ç­¾
          docker push "${IMAGE_NAME}:latest-manual"
